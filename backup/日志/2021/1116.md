# 晴



# 学习了

* Promise : 优雅的定义和组织异步逻辑
* async 和 await: 定义异步函数的机制

## 异步编程 

> 在 js 这种单线程的事件循环模型中, 同步操作与异步操作时代码所依赖的核心机制

### 早期异步机制

> 通过回调函数, 表明异步操作的完成, 但是这往往也会造成麻烦: 回调地狱 - **传入回调函数**

* 经常会存在一个回调依赖于另一个回调的情况



## 期约

> **对尚不存在结果的一个替身**

* 引用类型 Promise
* 通过 new 来实例化
* 传入一个 执行器函数作为参数 - 目的是: **初始化期约的异步行为和控制状态的最终转换**
* 期约的状态为私有的, 不能通过 js 检测到, 这是为了防止以同步的方式处理期约对象
* 期约里面调用 reject() 会抛出错误, 所以在期约落定为拒绝状态时, 还没有处理报错的话, 会报 `Uncaught (in promise) undefined`
* **执行器函数作为期约的初始化程序, 它是同步执行的, 定义既执行**



### 应用: 为了避免期约卡在待定状态, 添加一个定时退出功能



### 立即实例化解决的期约

> Promise.resolve() - 用这个方法实际上**可以把任意值都转化成期约**

1. **如果参数是一个期约 ==无论什么状态==**, 那么它的行为 **就相当于一个真空包装** - 还是返回原来的对象
2. 如果传入的是一个 **Error** 对象, 那么也会转换成一个 **解决了的期约** - 貌似不符合逻辑, 但确实如此

> Promise.reject() - 实例化一个立即拒绝的期约, 并抛出一个异步错误 (**且不能通过 try/catch 抓取**) - Promise 对象是同步对象, 但是也是 **也不执行模式的媒介** 代码一旦开始以异步模式执行, 则 **唯一与之交互的方式就是异步解构**

### 期约的方法

> 联通外部同步代码和内部异步代码之间的桥梁

#### 1. then()

* 添加处理程序的主要方法
* 两个参数: 1 - onResolved 处理程序 2 - onRejected 处理程序, 分别在进入对应状态时执行 **需要传入函数, 传入非函数会被静默忽略**
* .then() 方法会 **返回一个新的期约实例** -  ==基于onResovled 处理程序的返回值构建==
  1. 该返回值, **会通过 Promise.resolve() 包装**, 没有明确的返回值, 则默认返回 `undefined`
  2. 如果没有提供 resolve 处理程序, 则 **Promise.resolve() 包装上一个期约解决之后的值** 
  3. 如果在 `.then()` 中 `throw` 一个异常, 那么 **会返回一个拒绝的期约**
  4. 如果 return 的是一个 `Error` 实例, 那么会把错误对象包起来, 也会转换成一个 **解决了的期约**

#### 2. catch() - p332

> 处理程序 `return` 的值, 也会被 `Promise.resolve()` 包装, 其相当于语法糖是 `Promise.prototype.then(null, onRejected)` 的简写

* 仅仅是为了捕获错误后, 不抛出异常, 所以返回一个解决的期约理所当然
* 规则同 `then()`

#### 3. finally()

> 在期约状态落定后, 都会执行 - 无法知道期约的解决状态,  **主要用来添加清理代码** 

* 返回一个期约实例
* 大多数情况下都表现为父期约的传递
* **所以不管 finally 里面 `return` 了啥, 都是父期约的传递, 这点和上面两种不同** 
* 有两种情况例外的
  1. 返回的是待定期约
  2. 抛出了错误 (`throw `一个错误, 或者显式的返回一个 **拒绝期约**)

#### 4. 非重入特性

> 就是期约的处理程序, 一定是在当前同步代码执行完之后才执行 (**状态落定之后, 与之相关的处理程序才会被排期, 放到任务队列上去, 而不是立即执行**)



- 处理程序都会在被触发时, 添加到微任务队列执行
- 处理程序的执行顺序, 是按照他们被添加顺序执行



#### 5. 抛出错误

1. 在期约中抛出错误, 不会中断代码执行, 并且异步错误只能通过异步处理程序捕获



### 期约连锁

> 需要注意的是 .catch 处理函数会返回一个解决的期约



### 期约集成

1. Promise.all()
2. Promise.race()



### 期约扩展

#### 取消期约

> 期约正在处理, 但是程序却不再需要其结果, 这时候需要期约取消的特性 - 可以用临时封装进行解决 `取消令牌 cancel token`



#### 期约进度通知









